<h2>Permission list</h2>
<script>
    var parsedToken = isLoggedIn();
    if (parsedToken){
        //if admin role -> Request stuff from api
        var test = parsedToken['roles'];
        if(jQuery.inArray("admin", test) !== -1) {
            sendData('user', 'listAllPermission');
        }
    }
    else {
        $("#app").html('<button type="button" onclick="var page=\'/\';getPage(page);history.pushState(page, page, page);">Error Go Home</button>');
    }

    function onResponse(data){
        if (data['payload']!='' && data['payload']!='[]' && data['payload']!=null)
        {
            if (data['action'] == 'listAllPermission') {
                var payload = data['payload'] ;
                $("#app").append("<table id ='permissionlist' style='width:100%;margin-bottom:10px;'></table>");
                //foreach item in payload
                $("#permissionlist").append('<thead><tr><th>Permission</th></tr></thead><tbody></tbody>');
                var thead = [];
                payload.forEach ((permission, index) => {
                    permission['roles'].forEach ((role, index) => {
                        if(jQuery.inArray(role, thead) == -1)
                        {
                            thead.push(role);
                        }
                    });
                });
                //foreach thead item -> table head append
                thead.forEach ((item, index) => {
                    $("#permissionlist > thead > tr").append('<th>' + item + '</th>');
                });
                //foreach permission -> table body append
                payload.forEach ((permission, index) => {
                    $("#permissionlist > tbody").append("<tr id='"+ permission['permission_name'] +"'><td id='test' data-label='permission_name'>" + permission['permission_name'] + "</td></tr>");
                    thead.forEach ((item, index2) => {
                        if(jQuery.inArray(item, permission['roles']) < 0) {
                            $("#permissionlist > tbody > tr").last().append('<td class="alignright" data-label="cb_' + permission['permission_name'] + '-' + item + '"><input id="' + item + '"  type="checkbox"></td>');
                        }
                        else{
                            $("#permissionlist > tbody > tr").last().append('<td class="alignright" data-label="cb_' + permission['permission_name'] + '-' + item + '"><input id="' + item + '" type="checkbox" checked></td>');
                        }
                    });
                });
                $('#app').append('<button onclick="editAllPermission()">Save</button>');
            }
        }
    }

    function editAllPermission(){
        //TODO create array with dat
        var payload = [];
        $('#permissionlist > tbody > tr').each( function( index, value ) {
            //alert( "<tr>: " + value.id );
            var entry = {};
            entry['permission_name'] = value.id;
            entry['roles'] = [];
            $(value).children().each( function( index2, value2 ) {
                $(value2).children().each( function( index3, value3 ) {
                    //alert(value3.id);
                    if(value3.checked)
                    {
                        entry['roles'].push(value3.id);
                        //var roles = [];
                        //roles[] = value3.id;
                        //data['payload']['roles'] =
                        //alert('checked!!!!');
                    }
                    else {
                        //alert('not checked');
                    }
                });
            });
            payload.push(entry);
        });
        //TODO data['payload'] korrekt fÃ¼lla  mit data usem $('#permissionlist > tbody')
        //data['payload']['permission_name'] = $TODO_
        //data['payload']['roles'] = TODO
        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        sendData('user', 'editAllPermission', payload);
    }
    </script>
