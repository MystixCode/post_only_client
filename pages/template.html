<div class="grid-container">
    <div class="header">
        <a href='/'>
            <img src="/favicon.png">
            <h1>Mystix Client</h1>
        </a>
        <div id="usernav" class="dropdown">
            <button class="dropbtn">User</button>
            <div class="dropdown-content">
                <a href='/user/login/'>Login</a>
                <a href='/user/register/'>Register</a>
            </div>
        </div>
    </div>
    <div class="menu">

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <div class="topnav" id="myTopnav">
            <a href="/" class="active">Home</a>
            <a href="/about/">About</a>
            <a  class="icon" onclick="menuToggle()"><i class="fa fa-bars"></i></a>
        </div>

     </div>
     <div id="status" class="status" ></div>
     <div class="main">
         <div id="app" ></div>
     </div>
 </div>
<script>





    function menuToggle() {
      var x = document.getElementById("myTopnav");
      if (x.className === "topnav") {
        x.className += " responsive";
      } else {
        x.className = "topnav";
      }
    }


    function fade_out() {
      $("#status").fadeOut();
    }





    //If link clicked prevent default and get page via ajax
        $(document).on('click', 'a', function(event) {
            event.preventDefault();


            var page = $(this).attr('href').replace(/\/$/,'');
            getPage(page);
            if (page == '') {
                page = '/';
            }
            history.pushState(page, page, page);


            $("#myTopnav > a").removeClass('active')
            $(this).addClass('active');



        });

        // Revert to a previously saved browser history state
        window.addEventListener('popstate', function(event) {
            //alert('popstate fired!');
            console.log(event.state);
            var page =event.state;
            if (page == null) {
                page = '/';
            }
            getPage(page);
            //TODO go back or forward in history
            //history.go(-1);
            //history.pushState(page, page, page);
        });


    $( document ).ready(function() {
        var page = $(location).attr('pathname');
        getPage(page);
    });

    function getPage(page){ //expects a page like: /service/action/payload1/payload2/payload3...
        page = page.replace(/^\/|\/$/g, '');
        var pagearr = page.split('/');
        var service= pagearr[0];
        var action = pagearr[1];
        var payload = [];
        for (i = 2; i < pagearr.length; i++) {
            payload.push(pagearr[i]);
        }
        if (service && action && payload) {
            page = '/' + service + '/' + action;
        }
        else {
            page = '/' + page;
        }
        if (page == '' || page == '/') {
            page = '/home';
        }
        if (page == '/user/logout') {
            localStorage.removeItem('token');
            window.location.href = "https://mystixgame.tk";
        }
        //alert('service: ' + service + '\naction: ' + action  + '\npayload: ' + payload + '\npage: ' + page );
        //var pages = ["/home", "/about", "/user/login", "/user/register", "/user/edit", "/user/editOther", "/user/list", "/user/delete", "/user/deleteOther", "/character/list", "/character/create", "/character/delete", "/character/edit", "/page/add"];
    //    if  (pages.indexOf(page) !== -1) { //if page in pages
            $("#app").load('/pages' + page + '.html', payload);
    //    }
    }

    function sendData(data) {
        var jsondata = JSON.stringify(data);
        var token = localStorage.getItem("token");
        var authheader = false;
        if (token){
            authheader = {'Authorization':'Bearer ' + token};
        }
        return $.ajax({
            headers: authheader,
            type: "POST",
            url : "https://api.mystixgame.tk",
            contentType: "application/json",
            dataType: "json",
            data : jsondata,
            success: receiveData,
            error: function(response) {
                if (response.status == 401)
                {
                    alert('error 401');
                    //$("#app").html( '<button type="button" onclick="var page = \'/user/login\';getPage(page);history.pushState(page, page, page);">Error 401: Unauthorized,  Go to login page!</button>' );
                }
                else{
                    alert('Error: ' + response.status)
                }
                console.log("error");
                console.log(response);
            }
        });
    }

    function receiveData(data, textStatus, jqXHR) {
        //console.log("success");
        //console.log(data);
        onResponse(data, jqXHR);
    }

    function parseJWT (token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    }

    function isLoggedIn() {
        var token = localStorage.getItem("token");
        if (token){
            var parsedToken = parseJWT(token)
            if (parsedToken['username']){ //IF "LOGGEDIN"
                var unixtime = Math.round((new Date()).getTime() / 1000);
                if (parsedToken["exp"] > unixtime) {
                    dateObj = new Date(parsedToken['exp'] * 1000-unixtime*1000);
                    hours = dateObj.getUTCHours();
                    minutes = dateObj.getUTCMinutes();
                    seconds = dateObj.getUTCSeconds();
                    formattedTime = hours.toString().padStart(2, '0') + 'h ' +
                                    minutes.toString().padStart(2, '0') + 'min ' +
                                    seconds.toString().padStart(2, '0') + 's';
                    //$("#status").append('<p>token valid for + ' + formattedTime + '</p>');
                    addstuff(parsedToken);
                    return parsedToken;
                }
            }
        }
        //alert('token invalid');
        return false;
    }

    function addstuff(parsedToken) {
        $('#usernav').children('div').html("<a href='/user/edit/'>Edit</a><a href='/user/logout/'>Logout</a>");

        if ($('#myTopnav').children('a').length > 3){

        }
        else{

            $('#myTopnav').html("<a href='/'  class='active'>Home</a><a href='/about/'>About</a><a href='/character/list/'>Character List</a><a class='icon' onclick='menuToggle()'><i class='fa fa-bars'></i></a>");
            var test = parsedToken['roles'];
            if(jQuery.inArray("admin", test) !== -1) {
                //alert('isAdmin');
                $('#myTopnav').html("<a href='/' class='active'>Home</a><a href='/about/'>About</a><a href='/character/list/'>Character List</a><a href='/user/list/'>List User</a><a href='/page/add/'>Add Page</a><a href='/service/add/'>Add Service</a><a class='icon' onclick='menuToggle()'><i class='fa fa-bars'></i></a>");
            }
        }
    }
</script>
