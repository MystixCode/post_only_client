<html>
  <head>
    <link rel="shortcut icon" type="image/png" href="/favicon.png"/>
    <link rel="stylesheet" href="/style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  </head>
  <body>
  <div class="title">
    <a href='/'>
      <img src="/logo_64.png">
      <h1>Mystix Client</h1>
    </a>
  </div>
  <div id="usernav" class="dropdown">
   <button class="dropbtn">User</button>
   <div class="dropdown-content">
     <a href='/user/login/'>Login</a>
     <a href='/user/register/'>Register</a>
   </div>
  </div>

<nav id="mainnav">
  <ul>
    <li><a href='/'>Home</a></li>
    <li><a href='/about/'>About</a></li>
  </ul>
</nav>

<div id="app" ></div>
<div id="server-results"></div>

  <script>
 $(document).on('click', 'a', function(event) {
     event.preventDefault();
     var page = $(this).attr('href').replace(/\/$/,'');
    getPage(page);
    if (page == '')
    {
        page = '/';
    }
    history.pushState(page, page, page);
});

 // Revert to a previously saved browser history state
 window.addEventListener('popstate', function(event) {
   console.log('popstate fired!');
   console.log(event.state);
   var page =event.state;
    getPage(page);
 });

var page = $(location).attr('pathname').replace(/\/$/,'');
getPage(page);

function getPage(page){
    if (page == '' || page == '/')
    {
        page = '/home';
    }
    if (page == '/user/logout')
    {
       localStorage.removeItem('token');
       window.location.href = "https://mystixgame.tk";
    }
    var pages = ["/home", "/about", "/user/login", "/user/register", "/user/loggedin", "/user/edit", "/character/list"];

    if  (pages.indexOf(page) !== -1)
    { //if page in pages
      $("#app").load('/pages' + page + '.html');
    }
}

//TODO IF token in storage add Authorization: Bearer . token header

     function sendData(data) {
       var jsondata = JSON.stringify(data);
       var token = localStorage.getItem("token");
       return $.ajax({
         headers: {'Authorization':'Bearer ' + token},
         type: "POST",
         url : "https://api.mystixgame.tk",
         contentType: "application/json",
         dataType: "json",
         data : jsondata,
         success: receiveData,
         error: function(response) {
           console.log("error");
           console.log(response);
           $("#server-results").html(response);
         }
       });
     }

     function receiveData(data, textStatus, jqXHR)
     {
       console.log("success");
       console.log(data);
       switch(data['service']) {
         case "user":
           switch(data['action']) {
             case "login":
               $("#server-results").html(data['payload']);
               //if jwt in header goto loggedin page
               var token = jqXHR.getResponseHeader("Authorization").replace('Bearer ','');
               if (token){
                 //TODO if valide token received -> logged in
                 localStorage.setItem("token", token); //store token in browser web storage
                 var page = '/user/loggedin';
                 getPage(page);
                 history.pushState(page, page, page);
               }
               break;
             case "register":
               $("#server-results").html(data['payload']);
               break;
           }
           break;
         case "character":


            switch(data['action']) {
                case "list":
                //TODO!!!!!!!!!!!!!!!!!!!!!!!send data to function in character list script
                    $("#server-results").append(data['payload']);
                    $("#app").html("<div><ul id='characterlist'></ul></div>");
//todo foreach item in payload

                    data['payload'].forEach ((item, index) => {
                    	$("#characterlist").append("<li>" + item + "</li>");
                    });



                    break;
            }


           break;
         case "otherservice":
           alert("otherservice!!!!!!!!!!!!!!!!");
           break;
       }
     }

     function parseJWT (token) {
         var base64Url = token.split('.')[1];
         var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
         var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
             return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
         }).join(''));

         return JSON.parse(jsonPayload);
     }

    </script>
  </body>
 </html>
