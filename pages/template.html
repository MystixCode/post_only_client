<html>
    <head>
        <title>MystixGame</title>
        <link rel="shortcut icon" type="image/png" href="/favicon.png"/>
        <link rel="stylesheet" href="/style.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    </head>
    <body>
        <div class="title">
            <a href='/'>
                <img src="/logo_64.png">
                <h1>Mystix Client</h1>
            </a>
        </div>
        <div id="usernav" class="dropdown">
            <button class="dropbtn">User</button>
            <div class="dropdown-content">
                <a href='/user/login/'>Login</a>
                <a href='/user/register/'>Register</a>
            </div>
        </div>
        <nav id="mainnav">
            <ul>
                <li><a href='/'>Home</a></li>
                <li><a href='/about/'>About</a></li>
            </ul>
        </nav>
        <div id="app" ></div>
        <script>
        //If link clicked prevent default and get page via ajax
            $(document).on('click', 'a', function(event) {
                event.preventDefault();
                var page = $(this).attr('href').replace(/\/$/,'');
                getPage(page);
                if (page == '') {
                    page = '/';
                }
                history.pushState(page, page, page);
            });

            // Revert to a previously saved browser history state
            window.addEventListener('popstate', function(event) {
                console.log('popstate fired!');
                console.log(event.state);
                var page =event.state;
                getPage(page);
            });

            $( document ).ready(function() {
                var page = $(location).attr('pathname').replace(/\/$/,'');
                getPage(page);
            });

            function getPage(page){
                if (page == '' || page == '/') {
                    page = '/home';
                }
                if (page == '/user/logout') {
                    localStorage.removeItem('token');
                    window.location.href = "https://mystixgame.tk";
                }
                var pages = ["/home", "/about", "/user/login", "/user/register", "/user/edit", "/user/list", "/character/list"];
                if  (pages.indexOf(page) !== -1) { //if page in pages
                    $("#app").load('/pages' + page + '.html');
                }
            }

            function sendData(data) {
                var jsondata = JSON.stringify(data);
                var token = localStorage.getItem("token");
                return $.ajax({
                    headers: {'Authorization':'Bearer ' + token},
                    type: "POST",
                    url : "https://api.mystixgame.tk",
                    contentType: "application/json",
                    dataType: "json",
                    data : jsondata,
                    success: receiveData,
                    error: function(response) {
                        if (response.status == 401)
                        {
                            alert('error 401');
                            //$("#app").html( '<button type="button" onclick="var page = \'/user/login\';getPage(page);history.pushState(page, page, page);">Error 401: Unauthorized,  Go to login page!</button>' );
                        }
                        else{
                            alert('Error: ' + response.status)
                        }
                        console.log("error");
                        console.log(response);
                    }
                });
            }

            function receiveData(data, textStatus, jqXHR) {
                //console.log("success");
                //console.log(data);
                onResponse(data, jqXHR);
            }

            function parseJWT (token) {
                var base64Url = token.split('.')[1];
                var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            }

            function isLoggedIn() {
                var token = localStorage.getItem("token");
                if (token){
                    var parsedToken = parseJWT(token)
                    if (parsedToken['username']){ //IF "LOGGEDIN"
                        var unixtime = Math.round((new Date()).getTime() / 1000);
                        if (parsedToken["exp"] > unixtime) {
                            dateObj = new Date(parsedToken['exp'] * 1000-unixtime*1000);
                            hours = dateObj.getUTCHours();
                            minutes = dateObj.getUTCMinutes();
                            seconds = dateObj.getUTCSeconds();
                            formattedTime = hours.toString().padStart(2, '0') + 'h ' +
                                            minutes.toString().padStart(2, '0') + 'min ' +
                                            seconds.toString().padStart(2, '0') + 's';
                            $("#app").append('token valid for + ' + formattedTime);
                            addstuff(parsedToken);
                            return parsedToken;
                        }
                    }
                }
                //alert('token invalid');
                return false;
            }

            function addstuff(parsedToken) {
                $('#usernav').children('div').html("<a href='/user/edit/'>Edit</a><a href='/user/logout/'>Logout</a>");
                $('#mainnav').children('ul').html("<li><a href='/'>Home</a></li><li><a href='/about/'>About</a></li><li><a href='/character/list/'>List character</a></li>");
                var test = parsedToken['roles'];
                if(jQuery.inArray("admin", test) !== -1) {
                    //alert('isAdmin');
                    $('#mainnav').children('ul').html("<li><a href='/'>Home</a></li><li><a href='/about/'>About</a></li><li><a href='/character/list/'>List character</a></li><li><a href='/user/list/'>List User</a></li>");
                }
            }

        </script>
    </body>
</html>
